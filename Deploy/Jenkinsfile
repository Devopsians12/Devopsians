pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKERHUB_USERNAME = 'mohamedtarek123'
        BACKEND_IMAGE = 'devopsians-backend'
        FRONTEND_IMAGE = 'devopsians-frontend'
        IMAGE_TAG = "${BUILD_NUMBER}"
        EC2_HOST = '56.228.11.117'
        EC2_USER = 'ubuntu'
        SSH_KEY = credentials('ec2-ssh-key')
        FRONTEND_URL = "http://${EC2_HOST}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build images (local)') {
            steps {
                script {
                    bat 'docker build -t %DOCKERHUB_USERNAME%/%BACKEND_IMAGE%:%IMAGE_TAG% -f backend/Dockerfile .'
                    bat 'docker tag %DOCKERHUB_USERNAME%/%BACKEND_IMAGE%:%IMAGE_TAG% %DOCKERHUB_USERNAME%/%BACKEND_IMAGE%:latest'

                    bat 'docker build -t %DOCKERHUB_USERNAME%/%FRONTEND_IMAGE%:%IMAGE_TAG% -f frontend/Dockerfile --build-arg VITE_API_URL=http://%EC2_HOST%:3030 .'
                    bat 'docker tag %DOCKERHUB_USERNAME%/%FRONTEND_IMAGE%:%IMAGE_TAG% %DOCKERHUB_USERNAME%/%FRONTEND_IMAGE%:latest'
                }
            }
        }

        stage('Login & Push images') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASS')]) {
                    bat 'echo %DOCKERHUB_PASS% | docker login -u %DOCKERHUB_USER% --password-stdin'
                }
                bat 'docker push %DOCKERHUB_USERNAME%/%BACKEND_IMAGE%:%IMAGE_TAG% && docker push %DOCKERHUB_USERNAME%/%BACKEND_IMAGE%:latest'
                bat 'docker push %DOCKERHUB_USERNAME%/%FRONTEND_IMAGE%:%IMAGE_TAG% && docker push %DOCKERHUB_USERNAME%/%FRONTEND_IMAGE%:latest'
            }
        }

        stage('Deploy on EC2 via SSH') {
            steps {
                script {
                    withCredentials([
                        sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY_FILE'),
                        string(credentialsId: 'mongo-url', variable: 'MONGO_URL')
                    ]) {
                        // Upload docker-compose and env file
                        bat '"C:\\Program Files\\Git\\usr\\bin\\scp.exe" -i "%SSH_KEY_FILE%" -o StrictHostKeyChecking=no Deploy/docker-compose.yml %EC2_USER%@%EC2_HOST%:/home/%EC2_USER%/docker-compose.yml'
                        // Create .env on remote with required vars
                        bat '"C:\\Program Files\\Git\\usr\\bin\\ssh.exe" -i "%SSH_KEY_FILE%" -o StrictHostKeyChecking=no %EC2_USER%@%EC2_HOST% "echo DOCKERHUB_USERNAME=%DOCKERHUB_USERNAME% > ~/devopsians.env && echo MONGO_URL=%MONGO_URL% >> ~/devopsians.env && echo FRONTEND_URL=%FRONTEND_URL% >> ~/devopsians.env"'

                        // Pull latest images and restart stack
                        bat '"C:\\Program Files\\Git\\usr\\bin\\ssh.exe" -i "%SSH_KEY_FILE%" -o StrictHostKeyChecking=no %EC2_USER%@%EC2_HOST% "export \'$(cat ~/devopsians.env | xargs)\'; docker pull %DOCKERHUB_USERNAME%/%BACKEND_IMAGE%:latest && docker pull %DOCKERHUB_USERNAME%/%FRONTEND_IMAGE%:latest && docker compose -f ~/docker-compose.yml down || true && docker compose -f ~/docker-compose.yml up -d"'
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Deployed: http://${EC2_HOST}"
        }
        cleanup {
            script {
                if (isUnix()) {
                    sh 'docker logout || true'
                } else {
                    bat 'docker logout || true'
                }
            }
        }
    }
}