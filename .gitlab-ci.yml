# -----------------------------------------------
# Devopsians â€“ GitLab CI/CD Pipeline
# -----------------------------------------------
# Stages:
# 1. prepare   -> Install dependencies
# 2. test      -> Run test placeholder
# 3. build     -> Build frontend
# 4. docker    -> Build & push Docker images
# 5. deploy    -> Deploy to EC2 via SSH + docker compose
#
# Required Variables (GitLab > Settings > CI/CD > Variables):
#   DOCKERHUB_USERNAME
#   DOCKERHUB_PASSWORD
#   EC2_HOST
#   EC2_USER
#   EC2_SSH_KEY
#   MONGO_URL
#   FRONTEND_URL
#   VITE_API_URL (optional)
# -----------------------------------------------

stages:
  - prepare
  - test
  - build
  - docker
  - deploy

# Use workflow rules to define when pipeline triggers
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# -----------------------------------------------
# GLOBAL NODE TEMPLATE
# -----------------------------------------------
.default_node: &default_node
  image: node:20-alpine
  cache:
    key: "${CI_COMMIT_REF_SLUG}-node-cache"
    paths:
      - frontend/node_modules/
      - backend/node_modules/
  before_script:
    - node -v
    - npm -v

# -----------------------------------------------
# INSTALL DEPENDENCIES
# -----------------------------------------------
prepare:
  stage: prepare
  <<: *default_node
  script:
    - npm install --workspaces
    - npm install --prefix backend
    - npm install --prefix frontend
  artifacts:
    expire_in: 1h
    paths:
      - frontend/node_modules
      - backend/node_modules

# -----------------------------------------------
# TEST PLACEHOLDER
# -----------------------------------------------
test:
  stage: test
  <<: *default_node
  needs: ["prepare"]
  script:
    - echo "No tests defined yet. Skipping."

# -----------------------------------------------
# BUILD FRONTEND (Vite)
# -----------------------------------------------
build:
  stage: build
  <<: *default_node
  needs: ["prepare"]
  script:
    - export VITE_API_URL=${VITE_API_URL:-http://localhost:3030}
    - cd frontend && npm run build
  artifacts:
    expire_in: 1 day
    paths:
      - frontend/dist

# -----------------------------------------------
# DOCKER BUILD & PUSH
# -----------------------------------------------
docker:
  stage: docker
  image: docker:24.0.7
  services:
    - name: docker:24.0.7-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    IMAGE_TAG: ${IMAGE_TAG:-$CI_PIPELINE_IID}
  needs: ["build"]
  before_script:
    - apk add --no-cache bash openssh-client
    - docker version
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - echo "Building backend..."
    - docker build \
        -t $DOCKERHUB_USERNAME/devopsians-backend:$IMAGE_TAG \
        -t $DOCKERHUB_USERNAME/devopsians-backend:latest \
        -f backend/Dockerfile .

    - echo "Building frontend..."
    - docker build \
        --build-arg VITE_API_URL=${VITE_API_URL:-http://localhost:3030} \
        -t $DOCKERHUB_USERNAME/devopsians-frontend:$IMAGE_TAG \
        -t $DOCKERHUB_USERNAME/devopsians-frontend:latest \
        -f frontend/Dockerfile .

    - echo "Pushing images..."
    - docker push $DOCKERHUB_USERNAME/devopsians-backend:$IMAGE_TAG
    - docker push $DOCKERHUB_USERNAME/devopsians-backend:latest
    - docker push $DOCKERHUB_USERNAME/devopsians-frontend:$IMAGE_TAG
    - docker push $DOCKERHUB_USERNAME/devopsians-frontend:latest
  only:
    - main

# -----------------------------------------------
# DEPLOYMENT TO EC2 (SSH + docker compose)
# -----------------------------------------------
deploy:
  stage: deploy
  image: alpine:3.20
  variables:
    COMPOSE_FILE: ${DOCKER_COMPOSE_FILE:-Deploy/docker-compose.yml}
  needs: ["docker"]
  before_script:
    - apk add --no-cache openssh-client bash curl
    - mkdir -p ~/.ssh
    - echo "$EC2_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo -e "Host *\n  StrictHostKeyChecking no" > ~/.ssh/config
  script:
    - echo "Uploading docker-compose.yml ..."
    - scp $COMPOSE_FILE ${EC2_USER}@${EC2_HOST}:~/docker-compose.yml
    - echo "Creating environment file ..."
    - ssh ${EC2_USER}@${EC2_HOST} "echo NODE_ENV=production > ~/devopsians.env && echo PORT=3030 >> ~/devopsians.env && echo DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME >> ~/devopsians.env && echo FRONTEND_URL=$FRONTEND_URL >> ~/devopsians.env && echo MONGO_URL=$MONGO_URL >> ~/devopsians.env"
    - echo "Deploying containers ..."
    - ssh ${EC2_USER}@${EC2_HOST} "docker pull $DOCKERHUB_USERNAME/devopsians-backend:latest && docker pull $DOCKERHUB_USERNAME/devopsians-frontend:latest && docker compose -f docker-compose.yml down || true && source ~/devopsians.env && docker compose -f docker-compose.yml up -d"
    - echo "Performing health check ..."
    - ssh ${EC2_USER}@${EC2_HOST} "sleep 10 && curl -f http://localhost || echo 'Frontend not responding'"
  environment:
    name: production
    url: $FRONTEND_URL
  only:
    - main
